# Dockerfile
ARG NODE_VERSION=20

FROM node:${NODE_VERSION}-slim as base

ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"

WORKDIR /usr/src/app

RUN corepack enable
RUN apt update && apt install -y openssl

# Install dependencies into temp directory
COPY package.json pnpm-lock.yaml ./
RUN echo "Installing all dependencies" && \
    pnpm install --frozen-lockfile --verbose --ignore-scripts

# Copy all (non-ignored) project files into the image
COPY . .

# Set environment variables for build
ARG NEXT_PUBLIC_URL
ARG NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY
ARG CLERK_SECRET_KEY
ARG NEXT_PUBLIC_CLERK_SIGN_IN_URL
ARG NEXT_PUBLIC_CLERK_SIGN_UP_URL
ARG NEXT_PUBLIC_CLERK_SIGN_OUT_URL
ARG MAILGUN_API_KEY
ARG MAILGUN_API_URL
ARG MAILGUN_PUBLIC_KEY
ARG MAILGUN_DOMAIN
ARG OPENAI_API_KEY
ARG JWT_SECRET
ARG LEMON_SQUEEZY_API_KEY
ARG LEMON_SQUEEZY_STORE_ID
ARG LEMON_SQUEEZY_WEBHOOK_SECRET
ARG DATABASE_URL
ARG TEST_EMAIL
ARG TEST_PASSWORD
ARG TEST_EMAIL_SUB
ARG TEST_PASSWORD_SUB
ARG ENABLE_TEST_LOGS

ENV NEXT_PUBLIC_URL=${NEXT_PUBLIC_URL}
ENV NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=${NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY}
ENV CLERK_SECRET_KEY=${CLERK_SECRET_KEY}
ENV NEXT_PUBLIC_CLERK_SIGN_IN_URL=${NEXT_PUBLIC_CLERK_SIGN_IN_URL}
ENV NEXT_PUBLIC_CLERK_SIGN_UP_URL=${NEXT_PUBLIC_CLERK_SIGN_UP_URL}
ENV NEXT_PUBLIC_CLERK_SIGN_OUT_URL=${NEXT_PUBLIC_CLERK_SIGN_OUT_URL}
ENV MAILGUN_API_KEY=${MAILGUN_API_KEY}
ENV MAILGUN_API_URL=${MAILGUN_API_URL}
ENV MAILGUN_PUBLIC_KEY=${MAILGUN_PUBLIC_KEY}
ENV MAILGUN_DOMAIN=${MAILGUN_DOMAIN}
ENV OPENAI_API_KEY=${OPENAI_API_KEY}
ENV JWT_SECRET=${JWT_SECRET}
ENV LEMON_SQUEEZY_API_KEY=${LEMON_SQUEEZY_API_KEY}
ENV LEMON_SQUEEZY_STORE_ID=${LEMON_SQUEEZY_STORE_ID}
ENV LEMON_SQUEEZY_WEBHOOK_SECRET=${LEMON_SQUEEZY_WEBHOOK_SECRET}
ENV DATABASE_URL=${DATABASE_URL}
ENV TEST_EMAIL=${TEST_EMAIL}
ENV TEST_PASSWORD=${TEST_PASSWORD}
ENV TEST_EMAIL_SUB=${TEST_EMAIL_SUB}
ENV TEST_PASSWORD_SUB=${TEST_PASSWORD_SUB}
ENV ENABLE_TEST_LOGS=${ENABLE_TEST_LOGS}

ENV NODE_ENV production

RUN echo "Checking if Prisma CLI is installed" && \
    ls -la /usr/src/app/node_modules/.bin/prisma

RUN echo "Generating Prisma client" && \
    pnpm run prisma:generate

RUN echo "Building Next.js application" && \
    pnpm run build

RUN chmod -R 777 /usr/src/app/.next/cache

# Expose port and set entry point for the application
EXPOSE 3000/tcp
ENTRYPOINT ["pnpm", "run", "launch"]
